apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8sforbidimageprefix
spec:
  crd: 
    spec:
      names:
        kind: K8sForbidImagePrefix
      validation:  
        openAPIV3Schema:
          properties:
            parameters:
              type: object
              properties:
                forbidden_prefix:
                  type: string

  targets:
  - target: admission.k8s.gatekeeper.sh
    rego: |
      package k8sforbidimageprefix

      #
      # 1. Regular containers
      #
      violation[{"msg": msg}] {
        prefix := input.parameters.forbidden_prefix
        containers := object.get(input.review.object.spec.template.spec, "containers", [])
        container := containers[_]
        img := container.image
        startswith(img, prefix)

        msg := sprintf(
          "image '%v' in Containers is blocked. Forbidden prefix: '%v'. Please use a different image prefix, such as 'harbor.switch.tv/library'.",
          [img, prefix]
        )
      }

      #
      # 2. initContainers
      #
      violation[{"msg": msg}] {
        prefix := input.parameters.forbidden_prefix
        containers := object.get(input.review.object.spec.template.spec, "initContainers", [])
        container := containers[_]
        img := container.image
        startswith(img, prefix)

        msg := sprintf(
          "image '%v' in initContainers is blocked. Forbidden prefix: '%v'.",
          [img, prefix]
        )
      }

      #
      # 3. ephemeralContainers
      #
      violation[{"msg": msg}] {
        prefix := input.parameters.forbidden_prefix
        containers := object.get(input.review.object.spec.template.spec, "ephemeralContainers", [])
        container := containers[_]
        img := container.image
        startswith(img, prefix)

        msg := sprintf(
          "image '%v' in ephemeralContainers is blocked. Forbidden prefix: '%v'.",
          [img, prefix]
        )
      }

      #
      # startswith helper
      #
      startswith(s, prefix) {
        substring(s, 0, count(prefix)) == prefix
      }

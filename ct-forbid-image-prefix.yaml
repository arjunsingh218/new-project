apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8sforbidimageprefix
spec:
  crd: 
    spec:
      names:
        kind: K8sForbidImagePrefix
      validation:  
        openAPIV3Schema:
          properties:
            parameters:
              type: object
              properties:
                forbidden_prefix:
                  type: string

  targets:
  - target: admission.k8s.gatekeeper.sh 
    rego: |
      package k8sforbidimageprefix

      violation[{"msg": msg}] {
        prefix := input.parameters.forbidden_prefix
        img := input.review.object.spec.template.spec.containers[_].image
        startswith(img, prefix)

        msg := sprintf("image '%v' in initContainers is blocked. Forbidden prefix: '%v'. Please use a different image prefix, such as 'harbor.switch.tv/library'.", [img, prefix])
      }
      violation[{"msg": msg}] {
        prefix := input.parameters.forbidden_prefix

        input.review.object.spec.template.spec.initContainers != null
        container := input.review.object.spec.template.spec.initContainers[_]
        img := container.image
        startswith(img, prefix)

        msg := sprintf("image '%v' in initContainers is blocked. Forbidden prefix: '%v'", [img, prefix])
      }


      violation[{"msg": msg}] {
        prefix := input.parameters.forbidden_prefix

        input.review.object.spec.template.spec.ephemeralContainers != null
        container := input.review.object.spec.template.spec.ephemeralContainers[_]
        img := container.image
        startswith(img, prefix)

        msg := sprintf("image '%v' in ephemeralContainers is blocked. Forbidden prefix: '%v'", [img, prefix])
      }

      startswith(s, prefix) {
        substring(s, 0, count(prefix)) == prefix
      }